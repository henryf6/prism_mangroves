{
    "collab_server" : "",
    "contents" : "## ******************************************************************** ##\n## canopy_analysis.R \n##\n## Author: Henry Frye\n## Date Created: Aug 29 2019\n##\n##\n## Purpose:\n## Spectral derivative analysis\n## ******************************************************************** ##\n\n## ******************************************************************** ##\n####Canopy Set Up####\n## ******************************************************************** ##\nrm(list = ls())\n\n# Set working directory\nif(Sys.info()['user']=='henryfrye') setwd(\"/Users/henryfrye/Dropbox/Intellectual_Endeavours/UConn/Research/phd_research/chapter_2/mangrove_data/Ground_Spectra_01152014\")\n\n# Loading Packages\nlibrary(tidyverse)\nlibrary(ggthemes)\nlibrary(cowplot)\nlibrary(reshape2)\nlibrary(hsdar)\n\n#Read in canopy data\nmy.files <- list.files(pattern = \".txt\")\nmy.data <- lapply(my.files, \n                  read.csv, \n                  header=FALSE, sep=\",\", skip = 1)\nfor(i in 1:length(my.files)){\n names(my.data[[i]]) <- c(\"Wavelength\", \"Reflectance\")\n}\n\nstr(my.data)\n\n\ncanopy <- dplyr::bind_rows(my.data)\ncanopy$data_set <- rep(my.files, each =2151)\n\n#get data from long to wide\ncanopy_spec <- dcast(canopy,data_set ~ Wavelength, value.var = \"Reflectance\")\n\n#Read supplementary canopy data\ncanopy_supp <- read.csv('canopy_spectra_supp_info.csv')\n\n#join canopy spectra with supplement information\ncanopy_spectra <- inner_join(canopy_supp,canopy_spec, by = \"data_set\")\ncanopy_spectra <- canopy_spectra  %>% dplyr::filter(Description != \"BAD\")\n\n## ******************************************************************** ##\n####Spectral Reading####\n## ******************************************************************** ##\nmangrove_canopy.spec <- speclib(as.matrix(canopy_spectra[,3:1403]),350:1750)\nSI(mangrove_canopy.spec) <- canopy_spectra$Description\n\nmangrove_canopy.spec <- noiseFiltering(mangrove_canopy.spec, method = \"mean\", p = 15)\nmask(mangrove_canopy.spec) <- c(1325,1500)\n\nsp_red <- subset(mangrove_canopy.spec, V1 == \"Red Mangrove\")\nsp_white <- subset(mangrove_canopy.spec, V1 == \"White Mangrove\")\nwhite_red <- subset(mangrove_canopy.spec, V1 == \"White Mangrove Red Understory\")\nvine_brush <- subset(mangrove_canopy.spec, V1 == \"Vine brush overgrowth\")\nwhite_sand <- subset(mangrove_canopy.spec, V1 == \"White Mangrove Sand\")\nopen_low <- subset(mangrove_canopy.spec, V1 == \"open low brush\")\nhardwood <- subset(mangrove_canopy.spec, V1 == \"hardwood hammock\")\nbeach_coral <- subset(mangrove_canopy.spec, V1 == \"Beach Coral debris\")\nsand <- subset(mangrove_canopy.spec, V1 == \"Beach White Sand\")\ndune_grass <- subset(mangrove_canopy.spec, V1 == \"Dune Grass\")\nsea_grape  <- subset(mangrove_canopy.spec, V1 == \"sea grape tree\")\npneut <-  subset(mangrove_canopy.spec, V1 == \"pneutamophores/seagrass/sargassumdebris\")\ndry_shrub <-  subset(mangrove_canopy.spec, V1 == \"Med_Hgt_dry_shrub\")\nshort_red_sand <-  subset(mangrove_canopy.spec, V1 == \"2m_red_mangrove_sandy_soil\")\nmangrove_any <- subset(mangrove_canopy.spec, V1 == \"Red Mangrove\" | V1 == \"White Mangrove\")\n\nplot(sp_red, col = \"darkred\", ylim = c(0,1), main = \"Mean Species Reflectance\", lwd = 2)\nplot(sp_white, col = \"blue\",new = FALSE, lwd = 2)\n\n\n## ******************************************************************** ##\n####Band Depth Index####\n## ******************************************************************** ##\n#convex hull continuum removal transformation\nch_bd.r <- transformSpeclib(sp_red, method = \"ch\")\n\nch_bd.w <- transformSpeclib(sp_white, method = \"ch\")\n\n\n\n#png(\"mangrove_figures/band_index.png\")\nplot(ch_bd.r, col = \"darkred\", main = \"Band depth\", lwd = 2)\nplot(ch_bd.w,col = \"blue\", main = \"Band depth\", new = FALSE, lwd = 2)\n#these vertical lines are from the leaves but have similar placement...\n# abline(v = 484, col = \"red\")\n# abline(v = 667, col = \"red\")\n# #abline(v = 797, col = \"red\")\n# #abline(v = 865, col = \"red\")\n# abline(v = 976, col = \"red\")\n# abline(v = 1181, col = \"red\")\n# dev.off()\n\n## ******************************************************************** ##\n####Within and out canopy variation####\n## ******************************************************************** ##\nrad2deg <- function(rad) {(rad * 180) / (pi)}\n#create empty vector of average spectral angles for each species for within group variability \nsa_red <- c()\nsa_white <- c()\n\n#spectral variation within red canopies\nfor(i in 1:15){\n  sa_red[i] <- mean(sam(sp_red,sp_red[i,]), na.rm =TRUE)\n}\nmean(rad2deg(sa_red)) #3.627511\nsd(rad2deg(sa_red)) # 0.8548964\nrange(rad2deg(sa_red)) #2.707868 5.439511\n\n#spectral variation within white canopies\nfor(i in 1:5){\n  sa_white[i] <- mean(sam(sp_white,sp_white[i,]), na.rm =TRUE)\n}\nmean(rad2deg(sa_white)) #2.627095\nsd(rad2deg(sa_white)) #0.6447496\nrange(rad2deg(sa_white)) #2.477099 4.800206\n\n\n\n#spectral variability amongst red and white canopies\nr_w_dist <- c()\nfor(i in 1:5){\n  r_w_dist[i] <- mean(sam(sp_red,\n                          sp_white[i,]),na.rm=TRUE)\n}\nmean(rad2deg(r_w_dist)) #7.02128\nsd(rad2deg(r_w_dist)) #0.3581969\nrange(rad2deg(r_w_dist)) #6.662489 7.450530\n\n#spectral variability amongst white canopies and sand\nw_sand_dist <- c()\nfor(i in 1:5){\n  w_sand_dist[i] <- mean(sam(sp_white,\n                          sand[i,]),na.rm=TRUE)\n}\nmean(rad2deg(w_sand_dist)) #27.24064\nsd(rad2deg(w_sand_dist)) #0.422153\nrange(rad2deg(w_sand_dist)) #26.53766 27.64460\n\n#spectral variability amongst white canopies mixed sand and pure sand\nmixed_w_sand_dist <- c()\nfor(i in 1:5){\n  mixed_w_sand_dist[i] <- mean(sam(white_sand,\n                                   sp_white[i,]),na.rm=TRUE)\n}\nmean(rad2deg(mixed_w_sand_dist)) #7.273016\nsd(rad2deg(mixed_w_sand_dist)) #0.3830267\nrange(rad2deg(mixed_w_sand_dist)) #6.780190 7.683647\n\n## ******************************************************************** ##\n####Read in leaf level data for canopy comparison####\n## ******************************************************************** ##\n# Load Data\nblack <- read.csv(file = '../Leaf_spectra/blackMangroves_leaves.csv')\nred <- read.csv(file = '../Leaf_spectra/redMangroves_leaves.csv')\nwhite <- read.csv(file = '../Leaf_spectra/whiteMangroves_leaves.csv')\n\n#transpose data format (run once only or re-run with removing objects)\nbt <- t(black)\ncolnames(bt) <- bt[1,]\nblack <- bt[-1,]\n\nrt <- t(red)\ncolnames(rt) <- rt[1,]\nred <- rt[-1,]\n\nwt <- t(white)\ncolnames(wt) <- wt[1,]\nwhite <- wt[-1,]\n\n#merge all data into one dataframe\nall_spp <- rbind(black,white,red)\nall_spp <- as.data.frame(all_spp)\nall_spp$species <- c(rep(\"black\",20), rep(\"white\",20), rep(\"red\",20) )\nall_spp <- all_spp %>% dplyr::select(species,'350':'2500')\n\nmangrove.spec <- speclib(as.matrix(all_spp[,2:1402]),350:1750)\nSI(mangrove.spec) <- all_spp$species\n\nmangrove.spec <- noiseFiltering(mangrove.spec, method = \"mean\", p = 15)\nmask(mangrove.spec) <- c(1325,1500)\n\nred_leaf <- subset(mangrove.spec, V1 == \"red\")\nwhite_leaf <- subset(mangrove.spec, V1 == \"white\")\nblack_leaf <- subset(mangrove.spec, V1 == \"black\")\n\n## ******************************************************************** ##\n####Leaf/Canopy comparison####\n## ******************************************************************** ##\nr_lf_can <- c()\nw_lf_can <- c()\n\n#red leaf to canopy\nfor(i in 1:15){\n  r_lf_can[i] <- mean(sam(red_leaf,sp_red[i,]), na.rm =TRUE)\n}\nmean(rad2deg(r_lf_can)) #6.739692\nsd(rad2deg(r_lf_can)) #1.089595\nrange(rad2deg(r_lf_can)) #5.134318 9.122037\n\n#white leaf to canopy\nfor(i in 1:5){\n  w_lf_can[i] <- mean(sam(white_leaf,sp_white[i,]), na.rm =TRUE)\n}\nmean(rad2deg(w_lf_can)) #8.616156\nsd(rad2deg(w_lf_can)) #1.185051\nrange(rad2deg(w_lf_can)) #7.624838 10.426917\n\n## ******************************************************************** ##\n####Spectral Dissimilarity between cover classes####\n## ******************************************************************** ##\n\n#pure stands versus mixed\n##red versus red mixed\nred_red_mixed <- c()\n\nfor(i in 1:5){\n  red_red_mixed[i] <- mean(sam(sp_red,short_red_sand[i,]), na.rm =TRUE)\n}\nmean(rad2deg(red_red_mixed)) #4.84304\nsd(rad2deg(red_red_mixed)) #1.261944 \nrange(rad2deg(red_red_mixed)) #3.897022 6.833422\n\n##white versus white mixed\nwhite_white_mixed <- c()\n\nfor(i in 1:5){\n  white_white_mixed[i] <- mean(sam(sp_white,white_sand[i,]), na.rm =TRUE)\n}\nmean(rad2deg(white_white_mixed)) #7.273016\nsd(rad2deg(white_white_mixed)) #1.517101\nrange(rad2deg(white_white_mixed)) #5.974580 9.651308\n\n\n\n#pure mangrove stands versus mangal associates and other classes\n\n#hardwood vs. mangrove\nhard_man <- c()\n\nfor(i in 1:20){\n  hard_man[i] <- mean(sam(hardwood,mangrove_any[i,]), na.rm =TRUE)\n}\nmean(rad2deg(hard_man)) #6.451493\nsd(rad2deg(hard_man)) #2.744589\nrange(rad2deg(hard_man)) # 2.68535 10.76295\n\n#beach coral debris vs. mangrove\ncoral_man <- c()\nfor(i in 1:20){\n  coral_man[i] <- mean(sam(beach_coral,mangrove_any[i,]), na.rm =TRUE)\n}\nmean(rad2deg(coral_man)) #15.45387\nsd(rad2deg(coral_man)) #2.43415\nrange(rad2deg(coral_man)) #10.92950 19.35619\n\n#beach sand vs. mangrove\nsand_man <- c()\nfor(i in 1:20){\n  sand_man[i] <- mean(sam(sand,mangrove_any[i,]), na.rm =TRUE)\n}\nmean(rad2deg(sand_man)) #25.79926\nsd(rad2deg(sand_man)) #1.393946\nrange(rad2deg(sand_man)) #22.42468 27.82538\n\n#dune grass vs. mangrove\ndune_man <- c()\nfor(i in 1:20){\n  dune_man[i] <- mean(sam(dune_grass,mangrove_any[i,]), na.rm =TRUE)\n}\nmean(rad2deg(dune_man)) #27.53455\nsd(rad2deg(dune_man)) #2.845561\nrange(rad2deg(dune_man)) #21.68817 31.75241\n\n#sea grape vs. mangrove\ngrape_man <- c()\nfor(i in 1:20){\n  grape_man[i] <- mean(sam(sea_grape,mangrove_any[i,]), na.rm =TRUE)\n}\nmean(rad2deg(grape_man)) #5.545722\nsd(rad2deg(grape_man)) #1.616225\nrange(rad2deg(grape_man)) #2.789974 8.903423\n\n## ******************************************************************** ##\n####Spectral index comparison of leaves, canopies####\n## ******************************************************************** ##\n\n\nindex_comparison <- data.frame( \"species\" = as.factor( c( rep(\"black\",20), rep(\"red\",20), rep(\"white\",20), rep(\"red\",15), rep(\"white\",5) ) ),\n            \"type\" = as.factor(c(rep(\"leaf\",60),rep(\"canopy\",20) ) ),\n  \"NDVI\" = c( vegindex(black_leaf, \"NDVI\"), vegindex(red_leaf, \"NDVI\"), vegindex(white_leaf, \"NDVI\"),vegindex(sp_red, \"NDVI\"),vegindex(sp_white, \"NDVI\")  ),\n  \"PRI\" = c( vegindex(black_leaf, \"PRI\"), vegindex(red_leaf, \"PRI\"), vegindex(white_leaf, \"PRI\"),vegindex(sp_red, \"PRI\"),vegindex(sp_white, \"PRI\")  ),\n  \"Red_Edge\" = c(rededge(black_leaf)$lp, rededge(red_leaf)$lp, rededge(white_leaf)$lp,rededge(sp_red)$lp,rededge(sp_white)$lp),\n  \"Water_Index\" = c( vegindex(black_leaf, \"R900/R970\"), vegindex(red_leaf, \"R900/R970\"), vegindex(white_leaf, \"R900/R970\"),vegindex(sp_red, \"R900/R970\"),vegindex(sp_white, \"R900/R970\") ),\n  \"DVI\" = c( vegindex(black_leaf, \"R810 - ((R610+R661)/2)\"), vegindex(red_leaf, \"R810 - ((R610+R661)/2)\"), vegindex(white_leaf, \"R810 - ((R610+R661)/2)\"),vegindex(sp_red, \"R810 - ((R610+R661)/2)\"),vegindex(sp_white, \"R810 - ((R610+R661)/2)\") )) \n\nndvi<-ggplot(index_comparison, aes(x = species, y = NDVI,fill = type)) +\n  geom_boxplot(notch = TRUE) + \n  xlab(\"Species\") +\n  theme_classic() +\n  guides(fill=guide_legend(title=\"Type\")) +\n  theme(text = element_text(size=12, family = \"Helvetica\"),legend.position = \"none\")\n\npri <- ggplot(index_comparison, aes(x = species, y = PRI, fill = type)) + \n         geom_boxplot(notch = TRUE) + \n         xlab(\"Species\") +\n         ylab(\"Photochemical Reflectance Index\") +\n         theme_classic() +\n         guides(fill=guide_legend(title=\"Type\")) +\n         theme(text = element_text(size=10, family = \"Helvetica\"),legend.position = \"none\")\n\nre <- ggplot(index_comparison, aes(x = species, y = Red_Edge, fill = type)) +\n  geom_boxplot(notch = TRUE) + \n  xlab(\"Species\") +\n  ylab(\"Red Edge Inflection Position\") +\n  theme_classic() +\n  guides(fill=guide_legend(title=\"Type\")) +\n  theme(text = element_text(size=12, family = \"Helvetica\"),legend.position = \"none\")\n\nwi <- ggplot(index_comparison, aes(x = species, y = Water_Index, fill = type)) + \n  geom_boxplot(notch = TRUE) + \n  xlab(\"Species\") +\n  ylab(\"Canopy Water Index\") +\n  theme_classic() +\n  guides(fill=guide_legend(title=\"Type\")) +\n  theme(text = element_text(size=12, family = \"Helvetica\"),legend.position = c(.8,.2))\n\n\npanel_indices <- plot_grid(ndvi,pri,re,wi, labels = c('A', 'B','C','D'), label_size = 16)\npanel_indices\nggsave('../../mangrove_figures/index_panel.png', plot = panel_indices )\n#ggplot(index_comparison, aes(x = species, y = DVI, color = type)) + geom_boxplot(notch = TRUE)\n\n## ******************************************************************** ##\n####Graphic of threshholding####\n## ******************************************************************** ##\n\nangle_thresh <- data.frame(\"ground_cover\" <- c( rep(\"Red\", 5), rep(\"White\",5),\n                                                rep(\"Sea Grape\",20), rep(\"Hard\", 20),\n                                               rep(\"Sand\",20), rep(\"Coral\",20) ),\n                           \"angle\" <- c(rad2deg(red_red_mixed), rad2deg(white_white_mixed),\n                                        rad2deg(grape_man),rad2deg(hard_man),\n                                        rad2deg(sand_man),rad2deg(coral_man) ))\n\n\nggplot(angle_thresh, aes(angle, fill = ground_cover)) + \n  geom_histogram(alpha = .4, position = \"identity\") +\n  xlab('Spectral Angle (degrees)') + \n  ylab('Count') +\n  theme_tufte() +\n  guides(fill =  guide_legend(title=\"\")) +\n  theme(text = element_text(size=12, family = \"Helvetica\"),legend.position = c(.3,.75), legend.direction = \"horizontal\",\n        legend.text = element_text(size = 8))\n\n",
    "created" : 1571146067298.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "211834898",
    "id" : "B3E5566D",
    "lastKnownWriteTime" : 1572788285,
    "last_content_update" : 1572788285473,
    "path" : "~/Dropbox/Intellectual_Endeavours/UConn/Research/phd_research/chapter_2/mangroves_code/canopy_analysis.R",
    "project_path" : "canopy_analysis.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}